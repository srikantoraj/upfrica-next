<!-- public/debug-auth.html -->
<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1,viewport-fit=cover"
    />
    <title>API Auth/Slash Debug</title>
    <style>
      :root { color-scheme: light dark; }
      body { font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
      h1 { font-size: 20px; margin: 0 0 12px; }
      textarea, input { width: 100%; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
      textarea { padding: 8px; height: 120px; }
      input[type="text"] { padding: 8px; }
      button { padding: 10px 14px; border-radius: 8px; border: 0; background: #111827; color: #fff; cursor: pointer; }
      button[disabled] { opacity: .6; cursor: default; }
      table { width: 100%; border-collapse: collapse; table-layout: fixed; margin-top: 16px; }
      th, td { text-align: left; padding: 8px; border-bottom: 1px solid #e5e7eb; word-break: break-word; }
      .row { display: grid; gap: 12px; margin-bottom: 12px; }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
      details { margin-top: 14px; }
      pre { background:#0b1220; color:#e5e7eb; padding:12px; border-radius:8px; overflow:auto; max-height:50vh; }
      @media (prefers-color-scheme: dark) {
        th, td { border-color: #1f2937; }
        button { background: #2563eb; }
      }
    </style>
  </head>
  <body>
    <h1>API Auth/Slash Debug (static)</h1>

    <div class="row">
      <label>
        <div style="opacity:.7">Endpoints (one per line)</div>
        <textarea id="endpoints">/api/users/me/
/api/dashboard/tasks/
/api/dashboard/finance/</textarea>
      </label>

      <label>
        <div style="opacity:.7">
          Token (optional; if provided we’ll also test with
          <span class="mono">Authorization: Token &lt;token&gt;</span>)
        </div>
        <input id="token" type="text" placeholder="paste token…" />
      </label>

      <label style="display:flex;gap:8px;align-items:center">
        <input id="both" type="checkbox" checked />
        <span>Test both with and without trailing slash</span>
      </label>

      <div style="display:flex; gap:12px; align-items:center">
        <button id="run">Run tests</button>
        <span id="status" style="opacity:.7"></span>
      </div>
    </div>

    <table id="tbl" hidden>
      <thead>
        <tr>
          <th>Variant</th>
          <th>Endpoint</th>
          <th>Status</th>
          <th>ms</th>
          <th>x-up-proxy-auth</th>
          <th>source</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <details id="dump" hidden>
      <summary>Show full rows (headers & body)</summary>
      <pre id="dump-pre"></pre>
    </details>

    <script>
      (function () {
        const $ = (id) => document.getElementById(id);
        const endpointsEl = $("endpoints");
        const tokenEl = $("token");
        const bothEl = $("both");
        const runEl = $("run");
        const statusEl = $("status");
        const tblEl = $("tbl");
        const tbody = tblEl.querySelector("tbody");
        const dump = $("dump");
        const dumpPre = $("dump-pre");

        function getCookie(name) {
          const m = document.cookie.match(new RegExp("(?:^|; )" + name + "=([^;]*)"));
          return m ? decodeURIComponent(m[1]) : "";
        }

        function uniq(arr) {
          return Array.from(new Set(arr));
        }

        function expandEndpoints(lines, both) {
          const base = lines
            .split("\n")
            .map((s) => s.trim())
            .filter(Boolean);
          if (!both) return base;

          const out = [];
          for (const s of base) {
            out.push(s);
            const no = s.replace(/\/+$/, "");
            if (no !== s) out.push(no);
            else out.push(s + "/");
          }
          return uniq(out);
        }

        async function runFetch(url, title, opts) {
          const t0 = performance.now();
          const res = await fetch(url, {
            method: "GET",
            cache: "no-store",
            credentials: opts.withCreds, // "include" | "omit"
            headers: opts.headers || undefined,
          });
          const t1 = performance.now();
          const body = await res.text().catch(() => "");
          return {
            title,
            url,
            status: res.status,
            ms: Math.round(t1 - t0),
            "content-type": res.headers.get("content-type"),
            "x-up-proxy-auth": res.headers.get("x-up-proxy-auth"),
            "x-up-proxy-auth-source": res.headers.get("x-up-proxy-auth-source"),
            "x-up-had-cookie": res.headers.get("x-up-had-cookie"),
            "x-up-same-origin": res.headers.get("x-up-same-origin"),
            "x-up-proxy-target": res.headers.get("x-up-proxy-target"),
            body,
          };
        }

        async function onRun() {
          runEl.disabled = true;
          statusEl.textContent = "Running…";
          tblEl.hidden = true;
          dump.hidden = true;
          tbody.innerHTML = "";
          dumpPre.textContent = "";

          const token =
            tokenEl.value.trim() ||
            getCookie("up_auth") ||
            getCookie("authToken") ||
            getCookie("auth_token") ||
            getCookie("token");

          const eps = expandEndpoints(endpointsEl.value, bothEl.checked);
          const rows = [];

          try {
            for (const url of eps) {
              rows.push(await runFetch(url, "with cookies", { withCreds: "include" }));
              rows.push(await runFetch(url, "no cookies", { withCreds: "omit" }));
              if (token) {
                rows.push(
                  await runFetch(url, "Authorization header (omit cookies)", {
                    withCreds: "omit",
                    headers: { Authorization: "Token " + token },
                  })
                );
              }
            }
          } catch (e) {
            rows.push({ title: "error", url: "-", status: "-", ms: 0, body: String(e && e.message || e) });
          } finally {
            runEl.disabled = false;
          }

          // render table
          for (const r of rows) {
            const tr = document.createElement("tr");
            tr.innerHTML =
              "<td>" + r.title + "</td>" +
              "<td class='mono'>" + r.url + "</td>" +
              "<td>" + r.status + "</td>" +
              "<td>" + r.ms + "</td>" +
              "<td>" + (r["x-up-proxy-auth"] || "-") + "</td>" +
              "<td>" + (r["x-up-proxy-auth-source"] || "-") + "</td>";
            tbody.appendChild(tr);
          }
          tblEl.hidden = false;

          dumpPre.textContent = JSON.stringify(rows, null, 2);
          dump.hidden = false;
          statusEl.textContent = "Done.";
        }

        runEl.addEventListener("click", onRun);
      })();
    </script>
  </body>
</html>